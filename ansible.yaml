
- hosts: deployment
  become: true
  tasks:
    - apt:
        update_cache : yes

    - name: Downloading certificates for docker
      apt:
          name:
            - ca-certificates
            - curl
            - gnupg
          state: present

    - apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    
    - apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Downloading Docker
      apt:
          name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          state: present

    - service:
        name: docker
        state: started

    - user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Create application directory
      file:
        path: /mytrader
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copying Docker compose file
      copy:
          src: docker-compose.yaml
          dest: /mytrader/docker-compose.yaml

    - name: Ensure .env file exists with default version
      copy:
        dest: /my-trader/.env
        content: |
          APP_VERSION=latest
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        force: no


    - name: Pull and recreate containers with latest image
      command: docker compose up -d --pull always --force-recreate
      args:
        chdir: /mytrader

    - name: Cleanup unused docker resources
      command: docker system prune -af



    - name: Installing nginx
      apt:
        name: nginx
        state: present
      

    - name: Starting nginx
      service:
          name: nginx
          state: started
          enabled: yes

    - name: Copy template
      template:
          src: myapp.conf.j2
          dest: /etc/nginx/sites-available/myapp

    - name: Deleting default file
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Linking this enabled site
      file:
          src: /etc/nginx/sites-available/myapp
          dest: /etc/nginx/sites-enabled/myapp
          state: link
    
    - name: restarting the server
      service:
          name: nginx
          state: reloaded
          
  
     